import{fromJSON as B,crossSerializeStream as D,getCrossReferenceHeader as X}from"seroval";import{CustomEventPlugin as q,DOMExceptionPlugin as H,EventPlugin as E,FormDataPlugin as P,HeadersPlugin as A,ReadableStreamPlugin as C,RequestPlugin as x,ResponsePlugin as k,URLSearchParamsPlugin as O,URLPlugin as _}from"seroval-plugins/web";import{lazy as z,createComponent as J,createSignal as G,sharedConfig as F}from"solid-js";import{ssrElement as m,escape as I,mergeProps as K,ssr as L,ssrHydrationKey as V,renderToStringAsync as Q}from"solid-js/web";import{provideRequestEvent as U}from"solid-js/web/storage";import{H3Event as S,setResponseStatus as Y,setHeader as Z,getRequestURL as ee,getRequestIP as te,getResponseStatus as ne,getResponseStatusText as re,getCookie as se,setCookie as oe,getResponseHeaders as ae,getResponseHeader as ie,setResponseHeader as ue,appendResponseHeader as ce,getRequestWebStream as le,removeResponseHeader as pe,eventHandler as fe}from"h3";import{getContext as de}from"unctx";import{AsyncLocalStorage as he}from"node:async_hooks";import{createRouter as ge}from"radix3";function me(e){let t;const n=j(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...r,body:e.node.req.body}):new Request(n,{...r,get body(){return t||(t=He(e),t)}})}function ye(e){return e.web??={request:me(e),url:j(e)},e.web.request}function Re(){return Ae()}const h=Symbol("$HTTPEvent");function Se(e){return typeof e=="object"&&(e instanceof S||e?.[h]instanceof S||e?.__is_event__===!0)}function u(e){return function(...t){let n=t[0];if(Se(n))t[0]=n instanceof S||n.__is_event__?n:n[h];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(n=Re(),!n)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(n)}return e(...t)}}const j=u(ee),be=u(te),b=u(Y),$=u(ne),we=u(re),g=u(ae),v=u(ie),$e=u(ue),ve=u(ce),Te=u(se),qe=u(oe),M=u(Z),He=u(le),Ee=u(pe);function Pe(){return de("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:he})}function Ae(){return Pe().use().event}const y="Invariant Violation",{setPrototypeOf:Ce=function(e,t){return e.__proto__=t,e}}=Object;class w extends Error{framesToPop=1;name=y;constructor(t=y){super(typeof t=="number"?`${y}: ${t} (see https://github.com/apollographql/invariant-packages)`:t),Ce(this,w.prototype)}}function xe(e,t){if(!e)throw new w(t)}const R=Symbol("fetchEvent");function ke(e){return{request:ye(e),response:Ie(e),clientAddress:be(e),locals:{},nativeEvent:e,[h]:e}}function Oe(e){return{...e,[h]:e[h]}}function _e(e){if(!e[R]){const t=ke(e);e[R]=t}return e[R]}function T(e,t){for(const[n,r]of t.entries())M(e,n,r)}class Fe{constructor(t){this.event=t}get(t){const n=v(this.event,t);return Array.isArray(n)?n.join(", "):n}has(t){return this.get(t)!==void 0}set(t,n){return $e(this.event,t,n)}delete(t){return Ee(this.event,t)}append(t,n){ve(this.event,t,n)}getSetCookie(){const t=v(this.event,"Set-Cookie");return Array.isArray(t)?t:[t]}forEach(t){return Object.entries(g(this.event)).forEach(([n,r])=>t(Array.isArray(r)?r.join(", "):r,n,this))}entries(){return Object.entries(g(this.event)).map(([t,n])=>[t,Array.isArray(n)?n.join(", "):n])[Symbol.iterator]()}keys(){return Object.keys(g(this.event))[Symbol.iterator]()}values(){return Object.values(g(this.event)).map(t=>Array.isArray(t)?t.join(", "):t)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function Ie(e){return{get status(){return $(e)},set status(t){b(e,t)},get statusText(){return we(e)},set statusText(t){b(e,$(),t)},headers:new Fe(e)}}function Le(e){e.forEach(t=>{if(!t.attrs.href)return;let n=document.head.querySelector(`link[href="${t.attrs.href}"]`);n||(n=document.createElement("link"),n.setAttribute("rel","preload"),n.setAttribute("as","style"),n.setAttribute("href",t.attrs.href),document.head.appendChild(n))})}var Ue=" ";const je={style:e=>m("style",e.attrs,()=>I(e.children),!0),link:e=>m("link",e.attrs,void 0,!0),script:e=>e.attrs.src?m("script",K(()=>e.attrs,{get id(){return e.key}}),()=>L(Ue),!0):null};function Me(e){let{tag:t,attrs:{key:n,...r}={key:void 0},children:o}=e;return je[t]({attrs:r,key:n,children:o})}function Ne(e,t,n,r="default"){return z(async()=>{{const c=(await e.import())[r],i=(await t.inputs?.[e.src].assets()).filter(p=>p.tag==="style"||p.attrs.rel==="stylesheet");return typeof window<"u"&&Le(i),{default:p=>[...i.map(l=>Me(l)),J(c,p)]}}})}const N=[],We=Be(N.filter(e=>e.$component));function Be(e){function t(n,r,o,c){const a=Object.values(n).find(i=>o.startsWith(i.id+"/"));return a?(t(a.children||(a.children=[]),r,o.slice(a.id.length)),n):(n.push({...r,id:o,path:o.replace(/\/\([^)/]+\)/g,"")}),n)}return e.sort((n,r)=>n.path.length-r.path.length).reduce((n,r)=>t(n,r,r.path,r.path),[])}function De(e){return e.$GET||e.$POST||e.$PUT||e.$PATCH||e.$DELETE}ge({routes:N.reduce((e,t)=>{if(!De(t))return e;let n=t.path.replace(/\(.*\)\/?/g,"").replace(/\*([^/]*)/g,(r,o)=>`**:${o}`);if(/:[^/]*\?/g.test(n))throw new Error(`Optional parameters are not supported in API routes: ${n}`);if(e[n])throw new Error(`Duplicate API routes for "${n}" found at "${e[n].route.path}" and "${t.path}"`);return e[n]={route:t},e},{})});function Xe(){function e(n){return{...n,...n.$$route?n.$$route.require().route:void 0,info:{...n.$$route?n.$$route.require().route.info:{},filesystem:!0},component:Ne(n.$component,globalThis.MANIFEST.client,globalThis.MANIFEST.ssr),children:n.children?n.children.map(e):void 0}}return We.map(e)}function ze(e){const t=Te(e,"flash");if(!t)return;let n=JSON.parse(t);if(!n||!n.result)return[];const r=[...n.input.slice(0,-1),new Map(n.input[n.input.length-1])];return qe(e,"flash","",{maxAge:0}),{url:n.url,result:n.error?new Error(n.result):n.result,input:r}}async function Je(e){const t=globalThis.MANIFEST.client;return globalThis.MANIFEST.ssr,e.response.headers.set("Content-Type","text/html"),Object.assign(e,{manifest:await t.json(),assets:[...await t.inputs[t.handler].assets()],router:{submission:ze(e)},routes:Xe(),$islands:new Set})}var Ge=["<main",'><h1>Hello world!</h1><button id="test-inc" class="increment">Clicks: <span id="test-value">','</span></button><p>Visit <a href="https://start.solidjs.com" target="_blank">start.solidjs.com</a> to learn how to build SolidStart apps.</p></main>'];function Ke(){const[e,t]=G(0);return L(Ge,V(),I(e()))}function Ve(e){const n=e.length.toString(16),r="00000000".substring(0,8-n.length)+n;return new TextEncoder().encode(`;0x${r};${e}`)}function Qe(e,t){return new ReadableStream({start(n){D(t,{scopeId:e,plugins:[q,H,E,P,A,C,x,k,O,_],onSerialize(r,o){n.enqueue(Ve(o?`(${X(e)},${r})`:r))},onDone(){n.close()},onError(r){n.error(r)}})}})}async function Ye(e){const t=_e(e),n=t.request,r=n.headers.get("X-Server-Id"),o=n.headers.get("X-Server-Instance"),c=n.headers.has("X-Single-Flight"),a=new URL(n.url);let i,d;if(r)xe(typeof r=="string","Invalid server function"),[i,d]=r.split("#");else if(i=a.searchParams.get("id"),d=a.searchParams.get("name"),!i||!d)throw new Error("Invalid request");const p=(await globalThis.MANIFEST["server-fns"].chunks[i].import())[d];let l=[];if(!o||e.method==="GET"){const s=a.searchParams.get("args");s&&JSON.parse(s).forEach(f=>l.push(f))}if(e.method==="POST"){const s=n.headers.get("content-type");if(s.startsWith("multipart/form-data")||s.startsWith("application/x-www-form-urlencoded"))l.push(await new Request(n,{...n,body:e.node.req.body}).formData());else{const f=new Request(n,{...n,body:e.node.req.body});l=B(await f.json(),{plugins:[q,H,E,P,A,C,x,k,O,_]})}}try{let s=await U(t,async()=>(F.context={event:t},p(...l)));if(c&&o&&(s=await Ze(t,s)),s instanceof Response&&o&&(s.headers&&T(e,s.headers),s.customBody?s=await s.customBody():s.body==null&&(s=null)),!o){const f=s instanceof Error,W=new URL(n.headers.get("referer"));return new Response(null,{status:302,headers:{Location:W.toString(),...s?{"Set-Cookie":`flash=${JSON.stringify({url:a.pathname+encodeURIComponent(a.search),result:f?s.message:s,error:f,input:[...l.slice(0,-1),[...l[l.length-1].entries()]]})}; Secure; HttpOnly;`}:{}}})}return M(e,"content-type","text/javascript"),Qe(o,s)}catch(s){return s instanceof Response&&(s.status===302&&!o&&b(e,302),s.headers&&T(e,s.headers),s.customBody?s=await s.customBody():s.body==null&&(s=null)),s}}async function Ze(e,t){let n,r=new URL(e.request.headers.get("referer")).toString();t instanceof Response&&(t.headers.has("X-Revalidate")&&(n=t.headers.get("X-Revalidate").split(",")),t.headers.has("Location")&&(r=new URL(t.headers.get("Location"),new URL(e.request.url).origin+"").toString()));const o=Oe(e);return o.request=new Request(r),await U(o,async()=>{await Je(o),o.router.dataOnly=n||!0,o.router.previousUrl=e.request.headers.get("referer"),(async()=>{try{await Q(()=>{F.context={event:o},Ke()})}catch(i){console.log(i)}})();const c=o.router.data;if(!c)return t;let a=!1;for(const i in c)c[i]===void 0?delete c[i]:a=!0;return a&&(t instanceof Response||(c._$value=t,t=new Response(null,{status:200})),t.customBody=()=>c,t.headers.set("X-Single-Flight","true")),t})}const ct=fe(Ye);export{ct as default};
